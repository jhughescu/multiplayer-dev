<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master</title>
    <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src='templates/sustemplates.js'></script>
<!--    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>-->
    <link rel='stylesheet' href='css/basics.css'>
    <link rel='stylesheet' href='css/master.css'>
</head>

<body>
    <h1>Master {{me}}</h1>
    <p>This is the master client, it listens for player connections</p>
    <p id='message'></p>
    <button id='startSession'>Start Session</button>
    <button id='endSession'>End Session</button>
    <div id='players'></div>

    <div>
        <div id='controlPanel'>

        </div>
    </div>


    <script>
        const socket = io();
        const PINGBTN = `pingbtn-`;
        const RESETBTN = `resetbtn-`;
        let clientData = {role: 'admin'};
        let storedGame = null;
//        let storedGame = localStorage.getItem('susgame');
//        if (storedGame) {
//            storedGame = JSON.parse(storedGame);
//        }
//        console.log(`storedGame: ${JSON.stringify(storedGame)}`);

        const buttonSetup = () => {
            let b = document.getElementsByClassName('pingBtn');
            [...b].forEach((bu) => {
                bu.addEventListener('click', (evt) => {
                    let id = evt.target.id.replace(PINGBTN, '');
                    socket.emit('playerPing', id);
                });
            });
            b = document.getElementsByClassName('resetBtn');
            [...b].forEach((bu) => {
                bu.addEventListener('click', (evt) => {
                    let id = evt.target.id.replace(RESETBTN, '');
                    socket.emit('playerReset', id);
                });
            });
        };
        let ssb = document.getElementById('startSession');
        ssb.addEventListener('click', (evt) => {
            console.log('cow');
            socket.emit('startNewSession', function (s) {
                console.log('mooooooooooooooooooooo');
            });
        });
        let esb = document.getElementById('endSession');
        esb.addEventListener('click', (evt) => {
            socket.emit('adminTerminateSession');
        });
        const playerDisplay = (p, i) => {
            var e = document.getElementById('players');
            var s = '';
            s += `<div class='${p.active ? 'active' : 'inactive'}'>${p.id} <button class="pingBtn" id="${PINGBTN}${p.id}">Ping</button>`;
            s += `<button class="resetBtn" id="${RESETBTN}${p.id}">Reset</button></div>`;
            e.innerHTML += s;
        };
        const clearPlayers = () => {
            document.getElementById('players').innerHTML = ``;
        };
        const onPlayerConnect = (msg) => {
            document.getElementById('message').innerHTML += `<p>player ${msg} has connected</p>`;
        };
        const onGetPlayers = (arr) => {
//            console.log('onGetPlayers');
//            console.log(arr);
            clearPlayers();
            document.getElementById('players').innerHTML = '<b>players:</b>';
            for (var i = 0; i < arr.length; i++) {
                playerDisplay(arr[i], i);
//                console.log(players);
//                console.log(arr[i]);
            }
            buttonSetup();
        };
        const onGetPlayerIDsOld = (arr) => {
            console.log('onGetPlayerIDs');
            console.log(arr);
            clearPlayers();
            document.getElementById('players').innerHTML = '<b>players:</b>';
            for (var i = 0; i < arr.length; i++) {
                playerDisplay(arr[i], i);
//                console.log(players);
                console.log(arr[i]);
            }
            buttonSetup();
        };
        const newPlayer = (id) => {
            socket.emit('getPlayerIDs');
        };
        const updateSession = () => {
            socket.emit('updateSession');
        };
        //
        // Methods that could potentially be made universal
        const renderTemplate = (temp, targ, o) => {
            targ = '#' + targ;
            let ob = Object.assign({}, o);
            const compiledTemplate = Handlebars.templates[temp];
            const renderedHtml = compiledTemplate(ob);
//            console.log(renderedHtml)
//            console.log($(targ))
            $(targ).html(renderedHtml);
        };
        //
        //
        const getStoredGame = () => {
            storedGame = localStorage.getItem('susgame');
            if (storedGame) {
                storedGame = JSON.parse(storedGame);
            }
            return storedGame;
        };
        const storeGame = (g) => {
            console.log(`game stored now: ${JSON.stringify(g)}`);
            localStorage.setItem('susgame', JSON.stringify(g));
        };
        const getGameToStore = () => {
//            console.log('storegame');
            socket.emit('getGameMin', (g) => {
                console.log(`this is the only way to get the game data from the server`);
//                console.log(`the callback, setItem susgame: ${JSON.stringify(g)} (${Object.keys(g.p).length} elements)`);
                storeGame(g);
            })
        };
        const onServerShutdown = () => {
            console.log('SERVER SHUTTIING DOWN');
            getGameToStore()
        };
        const onServerStartup = () => {
            console.log('SERVER STARTED');
        };

        const getPlayerIDs = () => {
            socket.emit('getPlayerIDs', (ids) => {
                let o = {ids: Object.keys(ids)};
                console.log(o);
                renderTemplate('playersBasic', 'controlPanel', o);
            });
        };

        socket.on('connect', () => {
            if (storedGame) {
                console.log(`storedGame found of type ${typeof(storedGame)}: ${JSON.stringify(storedGame)} (${Object.keys(storedGame.p).length} elements)`);
//                console.log(storedGame);
                storedGame.version = 2;
                storedGame.elements = Object.keys(storedGame.p).length;
                socket.emit('storedGameFound', storedGame);
            }
            socket.emit('customDataEvent', clientData);
        });
        socket.on('onPlayerConnect', (msg) => {
            onPlayerConnect(msg);
        });
        socket.on('onGetPlayers', (msg) => {
//            console.log('I hear onGetPlayers')
            onGetPlayers(msg);
        });
        socket.on('onGetPlayerIDs', (msg) => {
//            console.log('I hear onGetPlayerIDs')
            onGetPlayerIDs(msg);
        });
        socket.on('updatePlayers', (arr) => {
            console.log('I hear updatePlayers')
            onGetPlayerIDs(arr);
        });
        socket.on('newPlayer', (players) => {
            newPlayer(players);
        });
        socket.on('onAddNewPlayer', () => {
            console.log('onAddNewPlayer');
            getGameToStore();
        });
        socket.on('serverShutdown', onServerShutdown);
        socket.on('serverStartup', onServerStartup);
        socket.on('updateFull', (o) => {
            console.log('full update');
            console.log(o);
            console.log({p: o.playersBasic});
            console.log(storedGame);
        });


        storedGame = getStoredGame();

        window.updateSession = updateSession;
        window.getPlayerIDs = getPlayerIDs;

//        socket.emit('getPlayers');

    </script>
</body>

</html>
